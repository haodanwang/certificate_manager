<!doctype html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>证书管理</title>
	<style>
		:root{
			--bg-start:#f8fafc; /* slate-50 */
			--bg-end:#eef2ff;   /* indigo-50 */
			--card:#ffffff;
			--text:#0f172a;    /* slate-900 */
			--muted:#64748b;   /* slate-500 */
			--border:#e5e7eb;  /* gray-200 */
			--primary:#6366f1; /* indigo-500 */
			--primary-600:#4f46e5; /* indigo-600 */
			--danger:#ef4444;  /* red-500 */
			--danger-600:#dc2626; /* red-600 */
			--success:#16a34a; /* green-600 */
		}
		*{box-sizing:border-box}
		body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin:0; background:linear-gradient(180deg,var(--bg-start),var(--bg-end)); color:var(--text)}
		.header{background:#ffffffcc; backdrop-filter:saturate(140%) blur(6px); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10}
		.header-inner{max-width:1120px; margin:0 auto; padding:14px 20px; display:flex; align-items:center; gap:12px}
		.brand{font-weight:700; letter-spacing:.2px; color:var(--text)}
		.container{max-width:1120px; margin:0 auto; padding:24px 20px}
		.card{background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 10px 30px rgba(2,8,20,.06)}
		.card-body{padding:18px}
		.section-title{font-size:18px; margin:0 0 12px; color:var(--text)}
		label{display:block; margin:6px 0 6px; font-weight:600; color:#334155}
		input,select,textarea{width:100%; background:#ffffff; color:var(--text); padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none; transition:border-color .2s, box-shadow .2s}
		input:focus,select:focus,textarea:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(99,102,241,.20)}
		.helper{color:var(--muted); font-size:12px; margin-top:6px}
		.actions{margin-top:12px; display:flex; gap:10px; align-items:center}
		.btn{display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:10px; border:1px solid transparent; cursor:pointer; font-weight:700}
		.btn-primary{background:linear-gradient(180deg,var(--primary),var(--primary-600)); color:#fff; box-shadow:0 6px 16px rgba(79,70,229,.25)}
		.btn-primary:hover{filter:brightness(1.05)}
		.btn-danger{background:linear-gradient(180deg,var(--danger),var(--danger-600)); color:#fff; box-shadow:0 6px 16px rgba(220,38,38,.20)}
		.btn-danger:hover{filter:brightness(1.05)}
		.flash{padding:10px 12px; border-radius:10px; margin:10px 0; border:1px solid var(--border)}
		.flash.error{background:#fee2e2; color:#7f1d1d}
		.flash.success{background:#dcfce7; color:#166534}
		.form-grid{display:grid; grid-template-columns:1fr; gap:14px}
		@media(min-width:860px){.form-grid{grid-template-columns:repeat(2,1fr)}}
		.form-span-2{grid-column:1}
		@media(min-width:860px){.form-span-2{grid-column:span 2}}
		.table-wrap{margin-top:20px}
		.table{border-collapse:separate; border-spacing:0; width:100%; overflow:hidden; border:1px solid var(--border); border-radius:12px; background:#fff}
		.table thead th{background:#f1f5f9; color:#334155; font-weight:700; text-align:left; padding:12px; border-bottom:1px solid var(--border)}
		.table tbody td{padding:12px; border-bottom:1px solid var(--border); color:#0f172a}
		.table tbody tr:nth-child(odd){background:#fafafa}
		.table tbody tr:hover{background:#f8fafc}
		.badge{display:inline-block; padding:2px 10px; border-radius:999px; border:1px solid #c7d2fe; background:#eef2ff; color:#3730a3; font-size:12px}
	</style>
</head>
<body>
	<div class="header">
		<div class="header-inner">
			<div class="brand">证书管理</div>
			<div class="helper">记录证书并到期提醒 · <a href="/settings" style="color:#4f46e5; text-decoration:none">SMTP 设置</a></div>
			<form method="post" action="/logout" style="margin-left:auto">
				<button class="btn btn-danger" type="submit">退出登录</button>
			</form>
		</div>
	</div>
	<div class="container">
		<div class="card">
			<div class="card-body">
				<h2 class="section-title">新增证书</h2>
	{% with messages = get_flashed_messages(with_categories=true) %}
		{% if messages %}
			{% for category, message in messages %}
				<div class="flash {{ category }}">{{ message }}</div>
			{% endfor %}
		{% endif %}
	{% endwith %}

		<form method="post" action="{{ url_for('add') }}">
			<div class="form-grid">
				<div>
					<label for="name">名称/类目</label>
					<input id="name" name="name" type="text" placeholder="例如：SSL 证书（生产网关）" required>
				</div>
				<div>
					<label for="email">接收提醒邮箱</label>
					<input id="email" name="email" type="email" placeholder="name@example.com" required>
				</div>
				<div>
					<label for="acquired_on">获取日期</label>
					<input id="acquired_on" name="acquired_on" type="date" required>
				</div>
				<div>
					<label for="valid_months">有效月数</label>
					<select id="valid_months" name="valid_months" required>
			<option value="permanent">永久</option>
			<script>
				(function(){
					var sel = document.currentScript.parentElement;
					for (var m = 2; m <= 36; m+=2) {
						var opt = document.createElement('option');
						opt.value = String(m);
						opt.textContent = m + ' 个月';
						sel.appendChild(opt);
					}
				})();
			</script>
					</select>
					<div class="helper">将根据“获取日期 + 有效月数”自动计算到期日期</div>
				</div>
				<div class="form-span-2">
					<label for="notes">备注</label>
					<textarea id="notes" name="notes" rows="2" placeholder="可选：用途、环境等"></textarea>
				</div>
			</div>
			<div class="actions">
				<div class="helper">到期日期预览：<span class="badge" id="expires_preview">-</span></div>
				<button class="btn btn-primary" type="submit">保存</button>
			</div>
		</form>
			</div>
		</div>

		<h2 class="section-title" style="margin:18px 0 10px">证书列表</h2>
	<table class="table">
		<thead>
			<tr>
				<th>ID</th>
				<th>名称</th>
				<th>邮箱</th>
				<th>获取日期</th>
				<th>有效(月)</th>
				<th>到期日期</th>
				<th>剩余</th>
				<th>上次提醒</th>
				<th>操作</th>
			</tr>
		</thead>
		<tbody>
			{% for r in records %}
			<tr>
				<td>{{ r.id }}</td>
				<td>{{ r.name }}</td>
				<td>{{ r.email }}</td>
				<td>{{ r.acquired_on }}</td>
				<td>{{ r.valid_months if r.valid_months >= 0 else '永久' }}</td>
				<td>{{ r.expires_label }}</td>
				<td>{{ r.days_left_label }}</td>
				<td>{{ r.last_reminded_on }}</td>
				<td>
					<form method="post" action="{{ url_for('delete', cid=r.id) }}" onsubmit="return confirm('确认删除该证书？');">
						<button class="btn btn-danger" type="submit">删除</button>
					</form>
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
	</div>

	<script>
		function pad(n){ return n < 10 ? '0' + n : '' + n }
		function addMonths(dateStr, months) {
			if(!dateStr || !months) return null;
			const parts = dateStr.split('-').map(Number);
			if(parts.length !== 3) return null;
			const y = parts[0], m = parts[1], d = parts[2];
			const zeroBased = m - 1;
			const total = zeroBased + months;
			const ny = y + Math.floor(total / 12);
			const nm = (total % 12 + 12) % 12; // 0-11
			const lastDay = new Date(ny, nm + 1, 0).getDate();
			const nd = Math.min(d, lastDay);
			const ndt = new Date(ny, nm, nd);
			return `${ndt.getFullYear()}-${pad(ndt.getMonth()+1)}-${pad(ndt.getDate())}`;
		}
		function updatePreview(){
			const acq = document.getElementById('acquired_on').value;
			const months = parseInt(document.getElementById('valid_months').value || '0', 10);
			const isPermanent = document.getElementById('valid_months').value === 'permanent';
			const out = isPermanent ? '永不过期' : addMonths(acq, months);
			document.getElementById('expires_preview').textContent = out || '-';
		}
		// 让点击日期输入框任意位置即可弹出原生日期选择器（支持 showPicker 的浏览器）
		document.addEventListener('DOMContentLoaded', function(){
			var dateInput = document.getElementById('acquired_on');
			if(!dateInput) return;
			function openPicker(){
				if (typeof dateInput.showPicker === 'function') {
					try { dateInput.showPicker(); } catch(e) {}
				}
			}
			dateInput.addEventListener('focus', function(){
				// 聚焦时尝试自动打开，避免还需点图标
				openPicker();
			});
			dateInput.addEventListener('mousedown', function(e){
				// 阻止默认以确保我们可以在点击任意处时打开选择器
				e.preventDefault();
				dateInput.focus();
				openPicker();
			});
		});
		document.getElementById('acquired_on').addEventListener('change', updatePreview);
		document.getElementById('valid_months').addEventListener('change', updatePreview);
		updatePreview();
	</script>
</body>
</html>


